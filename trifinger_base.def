Bootstrap: docker
From: ros:{{ ROS_DISTRO }}-ros-base

# To save time when rebuilding the image, you can pull the ROS image once and
# then use the following instead:
#Bootstrap: localimage
#From: ./ros_foxy-ros-base.sif

%arguments
    ROS_DISTRO=jazzy

%setup
    # needs to be created before %post, so it can be used as bind destination
    mkdir "${SINGULARITY_ROOTFS}/_cache"

%post -c /bin/bash
    set -e
    export DEBIAN_FRONTEND=noninteractive
    export XDG_CACHE_HOME=/_cache

    ROS_DISTRO={{ ROS_DISTRO }}

    # remove config that clears apt cache after each call (we want to keep it
    # in the bound folder); https://stackoverflow.com/a/73060162/2095383
    rm /etc/apt/apt.conf.d/docker-clean

    tmp_dir=$(mktemp -d)

    apt-get update
    apt-get dist-upgrade -y

    # basic tools
    apt-get install -y wget curl less parallel

    # alternative compilers
    apt-get install -y clang-19
    update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 19
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 19

    # use uv instead of pip as it is faster and seems to be better at resolving
    # complex dependencies
    curl -LsSf https://astral.sh/uv/install.sh | env UV_UNMANAGED_INSTALL="/usr/local/bin" sh
    export UV_SYSTEM_PYTHON=1
    export UV_BREAK_SYSTEM_PACKAGES=1
    export UV_LINK_MODE=copy
    export UV_COMPILE_BYTECODE=1

    # collect all python packages here to install together in the end (may help
    # to better resolve dependencies)
    python_packages=()

    # Build and Run Dependencies
    # ==========================

    apt-get install -y \
        freeglut3-dev \
        graphviz \
        libarmadillo-dev \
        libboost-iostreams-dev \
        libboost-filesystem-dev \
        libboost-thread-dev \
        libboost-program-options-dev \
        libcereal-dev \
        libedit-dev \
        libfmt-dev \
        libncurses5-dev \
        libnsl-dev \
        libopenblas-dev \
        libopencv-dev \
        libopencv-contrib-dev \
        libtomlplusplus-dev \
        libxmu-dev \
        libyaml-cpp-dev \
        ros-${ROS_DISTRO}-pinocchio \
        ros-${ROS_DISTRO}-xacro \
        ros-${ROS_DISTRO}-yaml-cpp-vendor

    # for building documentation
    apt-get install -y doxygen
    python_packages+=( breathing-cat )

    # for code formatting
    apt-get install -y clang-format
    python_packages+=( black )
    python_packages+=( cmakelang )


    # Tools for Debugging
    # ===================

    apt-get install -y \
        clang-tidy \
        gdb \
        valgrind \
        tmux \
        less \
        ipython3 \
        python3-ipdb \
        python3-psutil \
        python3-venv
    python_packages+=( line-profiler )


    apt-get install -y \
        python3-empy \
        python3-h5py \
        python3-matplotlib \
        python3-numpy \
        python3-opencv \
        python3-pandas \
        python3-progressbar \
        python3-ruamel.yaml \
        python3-scipy \
        python3-tabulate \
        python3-tqdm \
        python3-urwid \
        python3-yaml \
        python3-zarr

    # make sure we keep numpy at the version of python3-numpy
    python_packages+=( numpy==1.26.4 )
    #python_packages+=( scipy==1.11.4 )

    python_packages+=( gymnasium==1.2.0 )
    python_packages+=( numba==0.61.2 )
    python_packages+=( pybullet==3.2.7 )
    python_packages+=( namegenerator )

    uv pip install ${python_packages[@]}


    # create a setup file
    echo ". /opt/ros/${ROS_DISTRO}/setup.bash
source /usr/share/colcon_argcomplete/hook/colcon-argcomplete.bash
source /usr/share/colcon_cd/function/colcon_cd.sh
" > /setup.bash


    # cleanup
    rm -rf "${tmp_dir}"

%labels
    Version 4.0.0


%help
    Container for building the BLMC_EI/ROBOT_FINGER project.
    Run it with `singularity shell` at the root of your workspace, set up the
    environment by executing `source /setup.sh` and build with `colcon build`.
