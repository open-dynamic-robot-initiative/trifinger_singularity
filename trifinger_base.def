Bootstrap: docker
From: ros:dashing-ros-base

# To save time when rebuilding the image, you can pull the ROS image once and
# then use the following instead:
#Bootstrap: localimage
#From: ./ros_dashing-ros-base.sif

%post
    ROS_DISTRO=dashing

    apt-get update
    apt-get dist-upgrade -y

    # Build Dependencies
    # ==================

    apt-get install -y clang clang-format wget python3-pip curl

    apt-get install -y \
        freeglut3-dev \
        graphviz \
        libarmadillo-dev \
        libcereal-dev \
        libedit-dev \
        libncurses5-dev \
        libopenblas-dev \
        libopencv-dev \
        libxmu-dev \
        libyaml-cpp-dev \
        python3-empy \
        python3-yaml \
        ros-${ROS_DISTRO}-ament-cmake-nose \
        ros-${ROS_DISTRO}-xacro \
        ros-${ROS_DISTRO}-yaml-cpp-vendor

    # upgrade pip
    pip3 --no-cache-dir install --upgrade pip

    # for building documentation
    apt-get install -y doxygen
    pip3 --no-cache-dir install \
        doxypypy \
        sphinx \
        m2r \
        recommonmark \
        breathe \
        sphinxcontrib-moderncmakedomain \
        sphinx-rtd-theme

    # for code formatting
    pip3 --no-cache-dir install black cmakelang


    # Tools for Testing
    # =================

    apt-get install -y python3-nose python3-rednose


    # Tools for Debugging
    # ===================

    apt-get install -y \
        gdb \
        valgrind \
        tmux \
        less \
        ipython3 \
        python3-ipdb \
        python3-psutil


    # Run Dependencies
    # ================

    apt-get install -y \
        python3-progressbar \
        python3-matplotlib

    # upgrade numpy (needed for pybullet)
    pip3 --no-cache-dir install numpy==1.19.1
    pip3 --no-cache-dir install pybullet==2.8.4 gym==0.17.2

    apt-get install -y libopenmpi-dev zlib1g-dev
    pip3 --no-cache-dir install stable-baselines==2.10.0
    pip3 --no-cache-dir install tensorflow==1.14 pandas==0.24.2 joblib==0.16.0
    pip3 --no-cache-dir install opencv-contrib-python
    pip3 --no-cache-dir install namegenerator

    # Add robotpkg apt repository
    tee /etc/apt/sources.list.d/robotpkg.list <<EOF
deb [arch=amd64] http://robotpkg.openrobots.org/wip/packages/debian/pub $(lsb_release -sc) robotpkg
deb [arch=amd64] http://robotpkg.openrobots.org/packages/debian/pub $(lsb_release -sc) robotpkg
EOF
    # Register the authentication certificate of robotpkg
    curl http://robotpkg.openrobots.org/packages/debian/robotpkg.key | apt-key add -
    apt-get update
    # Note: for some reason, installation fails if the below packages are all
    # combined in one `apt-get install` call.
    apt-get install -y robotpkg-py36-pinocchio
    apt-get install -y robotpkg-py36-crocoddyl

    # clean up
    apt-get clean

    # create a setup file
    echo ". /opt/ros/${ROS_DISTRO}/setup.bash
source /usr/share/colcon_argcomplete/hook/colcon-argcomplete.bash
source /usr/share/colcon_cd/function/colcon_cd.sh
" > /setup.bash

%environment
    export PATH=/opt/openrobots/bin:$PATH
    export PKG_CONFIG_PATH=/opt/openrobots/lib/pkgconfig:$PKG_CONFIG_PATH
    export LD_LIBRARY_PATH=/opt/openrobots/lib:$LD_LIBRARY_PATH
    export PYTHONPATH=/opt/openrobots/lib/python3.6/site-packages:$PYTHONPATH

%labels
    Version 1.0.0

%help
    Container for building the BLMC_EI/ROBOT_FINGER project.
    Run it with `singularity shell` at the root of your workspace, set up the
    environment by executing `source /setup.sh` and build with `colcon build`.
