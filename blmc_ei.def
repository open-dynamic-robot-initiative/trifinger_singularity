# Install the BLMC_EI project software in the image so it can be used without
# building
Bootstrap: localimage
From: ./blmc_ei_base.sif

%setup
    ws_tmp_dir=$(mktemp -d -t build_challenge_image-XXXXXXXXXX)
    cd ${ws_tmp_dir}

    echo "Create workspace in ${ws_tmp_dir}"

    #git clone git@gitlab.is.tue.mpg.de:robotics/treep_robotics.git
    git clone git@github.com:machines-in-motion/treep_machines_in_motion.git
    treep --clone ROBOT_FINGERS

    # copy workspace into the image, omitting git information
    rsync -rl --exclude ".git" workspace/ ${SINGULARITY_ROOTFS}/opt/blmc_ei

    cd -
    rm -rf ${ws_tmp_dir}

%post
    NOW=`date`
    echo "export IMAGE_BUILD_DATE=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

    cd /opt/blmc_ei
    bash -c ". /setup.bash; colcon build"
    echo ". /opt/blmc_ei/install/local_setup.bash" >> /setup.bash


%runscript
    # run something with environment set up
    bash -c ". /setup.bash; $*"
