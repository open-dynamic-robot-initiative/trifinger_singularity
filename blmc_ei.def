# Install the BLMC_EI project software in the image so it can be used without
# building
Bootstrap: localimage
From: ./blmc_ei_base.sif

%setup
    ws_tmp_dir=$(mktemp -d -t build_challenge_image-XXXXXXXXXX)
    cd ${ws_tmp_dir}

    echo "Create workspace in ${ws_tmp_dir}"

    git clone -b real_robot_challenge git@gitlab.is.tue.mpg.de:robotics/treep_robotics.git
    git clone -b real_robot_challenge git@github.com:machines-in-motion/treep_machines_in_motion.git
    treep --clone BLMC_EI

    # copy workspace into the image, omitting git information
    rsync -rl --exclude ".git" workspace/ ${SINGULARITY_ROOTFS}/opt/blmc_ei

    cd -
    rm -rf ${ws_tmp_dir}

%post
    NOW=`date`
    echo "export IMAGE_BUILD_DATE=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

    # add rrc_simulation to the workspace
    cd /opt/blmc_ei/src
    git clone https://github.com/rr-learning/rrc_simulation.git

    cd /opt/blmc_ei
    bash -c ". /setup.bash; catbuild -DCMAKE_BUILD_TYPE=Release"
    echo ". /opt/blmc_ei/devel/setup.bash" >> /setup.bash

    # %environment does not seem to work when bootstrapping localimage...
    echo "export WORKSPACE=/ws" >> $SINGULARITY_ENVIRONMENT
    echo "export RUN_SCRIPT=/ws/src/usercode/run" >> $SINGULARITY_ENVIRONMENT

    # FIXME this is supposed to work, why does it not?
#%environment
#    WORKSPACE=/ws
#    RUN_SCRIPT=${WORKSPACE}/src/usercode/run

%runscript
    # run something with environment set up
    bash -c ". /setup.bash; $*"
